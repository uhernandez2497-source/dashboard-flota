<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ejecutivo - Mantenimiento de Flota</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  :root {
    --bg:#f0f4f8;--card:#ffffff;--primary:#2563eb;--primary-light:#dbeafe;--primary-dark:#1e40af;
    --accent:#7c3aed;--accent-light:#ede9fe;--teal:#0d9488;--teal-light:#ccfbf1;
    --orange:#ea580c;--orange-light:#fff7ed;--red:#dc2626;--red-light:#fef2f2;
    --green:#16a34a;--green-light:#f0fdf4;--text:#1e293b;--text-secondary:#64748b;
    --text-muted:#94a3b8;--border:#e2e8f0;
    --shadow:0 1px 3px rgba(0,0,0,0.06),0 4px 12px rgba(0,0,0,0.04);
    --shadow-lg:0 4px 24px rgba(0,0,0,0.08);--radius:16px;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

  .header{background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary) 50%,var(--accent) 100%);padding:20px 40px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(37,99,235,0.3)}
  .header-left{display:flex;align-items:center;gap:16px}
  .header-logo{width:44px;height:44px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
  .header h1{color:#fff;font-size:20px;font-weight:700;letter-spacing:-0.5px}
  .header p{color:rgba(255,255,255,0.7);font-size:12px;margin-top:2px}
  .header-right{display:flex;align-items:center;gap:10px}
  .header-badge{background:rgba(255,255,255,0.15);color:#fff;padding:5px 12px;border-radius:20px;font-size:11px;font-weight:500;display:flex;align-items:center;gap:6px}

  .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;animation:pulse 2s infinite}
  .status-dot.ok{background:#4ade80}.status-dot.loading{background:#facc15}.status-dot.error{background:#f87171}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

  .refresh-btn{background:rgba(255,255,255,0.2);color:#fff;border:1px solid rgba(255,255,255,0.3);padding:5px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:inherit;display:flex;align-items:center;gap:6px}
  .refresh-btn:hover{background:rgba(255,255,255,0.3)}
  .refresh-btn.spinning svg{animation:spin 0.8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .filters-bar{background:var(--card);padding:14px 40px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border);flex-wrap:wrap;box-shadow:0 2px 8px rgba(0,0,0,0.03)}
  .filter-group{display:flex;align-items:center;gap:6px}
  .filter-label{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px}
  .filter-buttons{display:flex;gap:4px;flex-wrap:wrap}
  .filter-btn{padding:5px 12px;border:1.5px solid var(--border);background:#fff;border-radius:8px;font-size:11px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all 0.2s;font-family:inherit}
  .filter-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
  .filter-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 2px 8px rgba(37,99,235,0.3)}
  .filter-divider{width:1px;height:28px;background:var(--border);margin:0 4px}
  .filter-reset{padding:5px 12px;border:none;background:var(--red-light);color:var(--red);border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:inherit}
  .filter-reset:hover{background:var(--red);color:#fff}
  .active-filters-info{font-size:11px;color:var(--text-muted);margin-left:auto}

  .main{padding:24px 40px;max-width:1600px;margin:0 auto}

  .conn-banner{border-radius:10px;padding:10px 20px;display:flex;align-items:center;gap:12px;margin-bottom:20px;font-size:12px;transition:all 0.3s;background:linear-gradient(90deg,#ecfdf5,#f0fdf4);border:1px solid #86efac;color:#166534}
  .conn-banner.error{background:linear-gradient(90deg,#fef2f2,#fff1f2);border-color:#fca5a5;color:#991b1b}
  .conn-banner.loading{background:linear-gradient(90deg,#fffbeb,#fef9c3);border-color:#fde047;color:#854d0e}
  .conn-banner-text{flex:1}.conn-banner-text strong{font-weight:700}

  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:20px}
  .kpi-card{background:var(--card);border-radius:var(--radius);padding:18px 20px;box-shadow:var(--shadow);display:flex;align-items:flex-start;gap:14px;transition:transform 0.2s,box-shadow 0.2s}
  .kpi-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
  .kpi-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
  .kpi-info{flex:1;min-width:0}
  .kpi-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
  .kpi-value{font-size:24px;font-weight:800;margin:3px 0;letter-spacing:-1px;line-height:1.1}
  .kpi-sub{font-size:11px;font-weight:600;color:var(--text-muted)}

  .charts-grid{display:grid;gap:16px;margin-bottom:20px}
  .grid-2{grid-template-columns:repeat(2,1fr)}.grid-2-1{grid-template-columns:2fr 1fr}
  .chart-card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);transition:box-shadow 0.2s}
  .chart-card:hover{box-shadow:var(--shadow-lg)}
  .chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .chart-title{font-size:14px;font-weight:700;color:var(--text)}
  .chart-subtitle{font-size:11px;color:var(--text-muted);margin-top:1px}
  .chart-badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:6px}
  .chart-container{position:relative;width:100%}

  .data-table{width:100%;border-collapse:separate;border-spacing:0}
  .data-table thead th{background:#f8fafc;padding:8px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--border);position:sticky;top:0}
  .data-table tbody td{padding:8px 12px;font-size:12px;border-bottom:1px solid #f1f5f9}
  .data-table tbody tr:hover{background:#f8fafc}
  .data-table .money{font-weight:600;font-variant-numeric:tabular-nums}
  .rank{width:24px;height:24px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:11px}
  .rank-1{background:#fef3c7;color:#b45309}.rank-2{background:#e2e8f0;color:#475569}.rank-3{background:#fed7aa;color:#c2410c}.rank-default{background:#f1f5f9;color:var(--text-secondary)}
  .pareto-tag{padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700}
  .pareto-vital{background:#fef2f2;color:#dc2626}.pareto-trivial{background:#f0fdf4;color:#16a34a}

  .donut-wrapper{position:relative;display:flex;justify-content:center}
  .donut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
  .donut-center-value{font-size:26px;font-weight:800;color:var(--text)}
  .donut-center-label{font-size:10px;color:var(--text-muted)}

  .section-title{font-size:16px;font-weight:700;color:var(--text);margin:28px 0 12px;display:flex;align-items:center;gap:10px}
  .section-title::before{content:'';width:4px;height:22px;background:var(--primary);border-radius:2px}

  @media(max-width:1200px){.grid-2,.grid-2-1{grid-template-columns:1fr}.main{padding:16px}.header,.filters-bar{padding-left:16px;padding-right:16px}}
  @media(max-width:768px){.kpi-grid{grid-template-columns:repeat(2,1fr)}.kpi-value{font-size:18px}}

  .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity 0.4s;gap:16px}
  .loading-overlay.hide{opacity:0;pointer-events:none}
  .spinner{width:44px;height:44px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite}
  .loading-text{font-size:14px;color:var(--text-secondary);font-weight:500}
  ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
  footer{text-align:center;padding:24px 0;color:var(--text-muted);font-size:11px}
</style>
</head>
<body>
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Conectando con OneDrive...</div>
</div>

<div class="header">
  <div class="header-left">
    <div class="header-logo">&#9881;</div>
    <div>
      <h1>Dashboard Ejecutivo - Mantenimiento</h1>
      <p id="headerSubtitle">Conectado a OneDrive</p>
    </div>
  </div>
  <div class="header-right">
    <div class="header-badge"><span class="status-dot loading" id="statusDot"></span><span id="statusText">Conectando...</span></div>
    <div class="header-badge" id="badgeRecords">-- registros</div>
    <div class="header-badge" id="lastUpdateBadge">Sin actualizar</div>
    <button class="refresh-btn" id="refreshBtn" onclick="loadFromOneDrive()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0118.8-4.3M22 12.5a10 10 0 01-18.8 4.3"/></svg>
      Actualizar
    </button>
  </div>
</div>

<div class="filters-bar">
  <div class="filter-group"><span class="filter-label">Ano:</span><div class="filter-buttons" id="filterYear"></div></div>
  <div class="filter-divider"></div>
  <div class="filter-group"><span class="filter-label">Mes:</span><div class="filter-buttons" id="filterMonth"></div></div>
  <div class="filter-divider"></div>
  <div class="filter-group"><span class="filter-label">Tipo:</span><div class="filter-buttons" id="filterTipo"></div></div>
  <div class="filter-divider"></div>
  <div class="filter-group"><span class="filter-label">Clasificacion:</span><div class="filter-buttons" id="filterClasif"></div></div>
  <div class="filter-divider"></div>
  <button class="filter-reset" onclick="resetFilters()">&#x21bb; Limpiar</button>
  <span class="active-filters-info" id="activeFiltersInfo"></span>
</div>

<div class="main">
  <div class="conn-banner loading" id="connBanner"><span style="font-size:18px">&#9889;</span><div class="conn-banner-text"><strong>OneDrive</strong> &mdash; <span id="connMsg">Conectando...</span></div></div>
  <div class="kpi-grid" id="kpiGrid"></div>

  <div class="charts-grid grid-2-1">
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Gasto por Mes</div><div class="chart-subtitle">Tendencia mensual + horas</div></div><div class="chart-badge" style="background:var(--primary-light);color:var(--primary)" id="badgeTotalGasto">--</div></div><div class="chart-container"><canvas id="chartGastoMes" height="260"></canvas></div></div>
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Clasificacion</div><div class="chart-subtitle">Correctivo vs Preventivo</div></div></div><div class="donut-wrapper"><canvas id="chartClasif" height="260"></canvas><div class="donut-center"><div class="donut-center-value" id="donutClasifValue">--</div><div class="donut-center-label">Servicios</div></div></div></div>
  </div>

  <div class="section-title">Analisis por Vehiculo</div>
  <div class="charts-grid grid-2">
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Top 10 Vehiculos - Mayor Gasto</div><div class="chart-subtitle">Mayor inversion en mantenimiento</div></div></div><div class="chart-container"><canvas id="chartTop10" height="320"></canvas></div></div>
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Top 10 Vehiculos - Horas Consumidas</div><div class="chart-subtitle">Mayor consumo de tiempo</div></div></div><div class="chart-container"><canvas id="chartTop10Horas" height="320"></canvas></div></div>
  </div>

  <div class="section-title">Tendencias y Comparativos</div>
  <div class="charts-grid grid-2">
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Consumo de Horas por Mes</div><div class="chart-subtitle">Horas y promedio por servicio</div></div></div><div class="chart-container"><canvas id="chartHorasMes" height="280"></canvas></div></div>
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Servicios por Tipo</div><div class="chart-subtitle">Distribucion por tipo de servicio</div></div></div><div class="chart-container"><canvas id="chartTipoServ" height="280"></canvas></div></div>
  </div>

  <div class="charts-grid grid-2-1">
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Comparativo Mensual</div><div class="chart-subtitle">Gasto, horas y servicios</div></div></div><div style="overflow-x:auto"><table class="data-table" id="tableComparativo"><thead><tr><th>Periodo</th><th>Servicios</th><th>Gasto Total</th><th>Horas</th><th>$/Serv</th><th>Hrs/Serv</th></tr></thead><tbody></tbody></table></div></div>
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Tipo de Equipo</div><div class="chart-subtitle">Distribucion de flota</div></div></div><div class="donut-wrapper"><canvas id="chartTipoEquipo" height="260"></canvas><div class="donut-center"><div class="donut-center-value" id="donutTipoValue">--</div><div class="donut-center-label">Equipos</div></div></div></div>
  </div>

  <div class="section-title">Analisis de Pareto 80/20</div>
  <div class="charts-grid grid-2">
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Pareto de Gasto por Vehiculo</div><div class="chart-subtitle">20% que genera el 80% del gasto</div></div></div><div class="chart-container"><canvas id="chartPareto" height="320"></canvas></div></div>
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Detalle Pareto</div><div class="chart-subtitle">Acumulado y zona 80/20</div></div></div><div style="overflow-x:auto;max-height:400px;overflow-y:auto"><table class="data-table" id="tablePareto"><thead><tr><th>#</th><th>Vehiculo</th><th>Gasto</th><th>% Acum.</th><th>Zona</th></tr></thead><tbody></tbody></table></div></div>
  </div>

  <div class="charts-grid grid-2">
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Pareto de Horas por Vehiculo</div><div class="chart-subtitle">20% que consume 80% de horas</div></div></div><div class="chart-container"><canvas id="chartParetoHoras" height="320"></canvas></div></div>
    <div class="chart-card"><div class="chart-header"><div><div class="chart-title">Desglose de Costos</div><div class="chart-subtitle">Refacciones vs Mano de Obra vs Otros</div></div></div><div class="chart-container"><canvas id="chartDesglose" height="320"></canvas></div></div>
  </div>

  <footer>Dashboard Ejecutivo de Mantenimiento &bull; Datos en vivo desde OneDrive &bull; Click Actualizar para refrescar<br><span id="footerTimestamp"></span></footer>
</div>

<script>
// ══════════════════════════════════════
// CONFIG
// ══════════════════════════════════════
const ONEDRIVE_DOWNLOAD = 'https://proxylogis-my.sharepoint.com/personal/carlosu_hernandez_mecanicatek_com/_layouts/15/download.aspx?share=IQD1veTLe2bTQIoFUNNe7y3yAbHvcj7IDM0w9biOCEQXTLw';
const CORS_PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];
const SHEET_NAME = 'bd';

// Column indices in the bd sheet (0-based)
const COL = {equipo:4,tipo_equipo:8,marca:10,modelo:11,razon:13,refaccion:32,mano_obra:33,otros:34,total:35,dias_real:40,dias_atraso:41,nodo:45,region:46,clasificacion:63,tipo_servicio:64,tiempo:68,familia:69,mes:70,ano:71,grupo:7};

const MONTH_ORDER = {enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,julio:7,agosto:8,septiembre:9,octubre:10,noviembre:11,diciembre:12};
const MONTH_SHORT = {enero:'Ene',febrero:'Feb',marzo:'Mar',abril:'Abr',mayo:'May',junio:'Jun',julio:'Jul',agosto:'Ago',septiembre:'Sep',octubre:'Oct',noviembre:'Nov',diciembre:'Dic'};
const PALETTE = ['#2563eb','#7c3aed','#0d9488','#ea580c','#dc2626','#16a34a','#d946ef','#0284c7','#ca8a04','#be185d','#6366f1','#059669'];

let RAW_DATA = [];
let filters = {year:'all',month:'all',tipo:'all',clasif:'all'};
let charts = {};

// ══════════════════════════════════════
// LOAD FROM ONEDRIVE (via CORS proxy)
// ══════════════════════════════════════
async function loadFromOneDrive() {
  setStatus('loading','Descargando Excel de OneDrive...');
  document.getElementById('refreshBtn').classList.add('spinning');

  let arrayBuffer = null;
  for (let i = 0; i < CORS_PROXIES.length; i++) {
    const proxyUrl = CORS_PROXIES[i](ONEDRIVE_DOWNLOAD);
    try {
      setStatus('loading', `Intentando proxy ${i+1}/${CORS_PROXIES.length}...`);
      const resp = await fetch(proxyUrl, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      arrayBuffer = await resp.arrayBuffer();
      if (arrayBuffer.byteLength < 1000) throw new Error('Response too small');
      break;
    } catch(e) {
      console.warn(`Proxy ${i+1} failed:`, e.message);
      if (i === CORS_PROXIES.length - 1) {
        setStatus('error', `No se pudo descargar. Verifica que el link de OneDrive sea publico.`);
        document.getElementById('refreshBtn').classList.remove('spinning');
        return;
      }
    }
  }

  try {
    setStatus('loading','Parseando Excel...');
    const wb = XLSX.read(new Uint8Array(arrayBuffer), {type:'array'});
    const ws = wb.Sheets[SHEET_NAME] || wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});

    RAW_DATA = [];
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      if (!r[COL.equipo]) continue;
      const sf = v => {const n=parseFloat(v);return isNaN(n)?0:n;};
      const ss = v => v==null?'':String(v).trim();
      RAW_DATA.push({
        equipo:ss(r[COL.equipo]),tipo_equipo:ss(r[COL.tipo_equipo]),marca:ss(r[COL.marca]),
        modelo:ss(r[COL.modelo]),razon_reparacion:ss(r[COL.razon]),
        precio_refaccion:sf(r[COL.refaccion]),precio_mano_obra:sf(r[COL.mano_obra]),
        precio_otros:sf(r[COL.otros]),total:sf(r[COL.total]),
        dias_real:sf(r[COL.dias_real]),dias_atraso:sf(r[COL.dias_atraso]),
        nodo:ss(r[COL.nodo]),region:ss(r[COL.region]),
        clasificacion:ss(r[COL.clasificacion]),tipo_servicio:ss(r[COL.tipo_servicio]),
        tiempo_estandar:sf(r[COL.tiempo]),familia:ss(r[COL.familia]),
        mes:ss(r[COL.mes]).toLowerCase(),ano:ss(r[COL.ano]),grupo_manto:ss(r[COL.grupo])
      });
    }

    const ts = new Date().toLocaleString('es-MX');
    setStatus('ok', `${RAW_DATA.length} registros cargados | ${ts}`);
    document.getElementById('lastUpdateBadge').textContent = ts;
    document.getElementById('footerTimestamp').textContent = `Ultima carga: ${ts} | Fuente: OneDrive | ${(arrayBuffer.byteLength/1024).toFixed(0)} KB`;
    setupFilters();
    updateDashboard();
  } catch(e) {
    setStatus('error','Error parseando Excel: '+e.message);
    console.error(e);
  }
  document.getElementById('refreshBtn').classList.remove('spinning');
}

function setStatus(s,msg) {
  const dot=document.getElementById('statusDot'),txt=document.getElementById('statusText'),
        banner=document.getElementById('connBanner'),cm=document.getElementById('connMsg');
  dot.className=`status-dot ${s}`;
  banner.className=`conn-banner ${s==='ok'?'':s}`;
  txt.textContent={ok:'Conectado',loading:'Cargando...',error:'Error'}[s]||s;
  cm.textContent=msg;
  document.getElementById('loadingText').textContent=msg;
}

// ══════════════════════════════════════
// FILTERS
// ══════════════════════════════════════
function setupFilters() {
  const y=[...new Set(RAW_DATA.map(r=>r.ano))].filter(Boolean).sort();
  const m=[...new Set(RAW_DATA.map(r=>r.mes))].filter(Boolean).sort((a,b)=>(MONTH_ORDER[a]||99)-(MONTH_ORDER[b]||99));
  const t=[...new Set(RAW_DATA.map(r=>r.tipo_equipo))].filter(Boolean).sort();
  const c=[...new Set(RAW_DATA.map(r=>r.clasificacion))].filter(Boolean).sort();
  renderBtns('filterYear','year',y,v=>v);renderBtns('filterMonth','month',m,v=>cap(v));
  renderBtns('filterTipo','tipo',t,v=>v);renderBtns('filterClasif','clasif',c,v=>v);
}
function renderBtns(id,key,vals,fn){
  const el=document.getElementById(id),cur=filters[key];
  let h=`<button class="filter-btn ${cur==='all'?'active':''}" data-f="${key}" data-v="all" onclick="setF('${key}','all')">Todos</button>`;
  vals.forEach(v=>{h+=`<button class="filter-btn ${cur===v?'active':''}" data-f="${key}" data-v="${v}" onclick="setF('${key}','${v}')">${fn(v)}</button>`;});
  el.innerHTML=h;
}
function setF(k,v){filters[k]=v;document.querySelectorAll(`[data-f="${k}"]`).forEach(b=>b.classList.toggle('active',b.dataset.v===v));updateDashboard();}
function resetFilters(){filters={year:'all',month:'all',tipo:'all',clasif:'all'};setupFilters();updateDashboard();}
function getFiltered(){return RAW_DATA.filter(r=>{
  if(filters.year!=='all'&&r.ano!==filters.year)return false;
  if(filters.month!=='all'&&r.mes!==filters.month)return false;
  if(filters.tipo!=='all'&&r.tipo_equipo!==filters.tipo)return false;
  if(filters.clasif!=='all'&&r.clasificacion!==filters.clasif)return false;return true;
});}

// ══════════════════════════════════════
// UTILS
// ══════════════════════════════════════
function cap(s){return s?s[0].toUpperCase()+s.slice(1):'';}
function fm(v){return'$'+v.toLocaleString('es-MX',{minimumFractionDigits:0,maximumFractionDigits:0});}
function fmf(v){return'$'+v.toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fn(v){return v.toLocaleString('es-MX',{maximumFractionDigits:1});}
function fp(v){return(v*100).toFixed(1)+'%';}
function gb(d,f){const m={};d.forEach(r=>{const k=f(r);if(!m[k])m[k]=[];m[k].push(r);});return m;}
function dc(id){if(charts[id]){charts[id].destroy();delete charts[id];}}
function sp(keys){const mo={Ene:1,Feb:2,Mar:3,Abr:4,May:5,Jun:6,Jul:7,Ago:8,Sep:9,Oct:10,Nov:11,Dic:12};return keys.sort((a,b)=>{const[ma,ya]=[a.split(' ')[0],a.split(' ')[1]],[mb,yb]=[b.split(' ')[0],b.split(' ')[1]];return(ya-yb)||((mo[ma]||0)-(mo[mb]||0));});}

// ══════════════════════════════════════
// DASHBOARD UPDATE
// ══════════════════════════════════════
function updateDashboard(){
  const d=getFiltered();
  const p=[];if(filters.year!=='all')p.push('Ano: '+filters.year);if(filters.month!=='all')p.push('Mes: '+cap(filters.month));
  if(filters.tipo!=='all')p.push('Tipo: '+filters.tipo);if(filters.clasif!=='all')p.push(filters.clasif);
  document.getElementById('activeFiltersInfo').textContent=p.length?'Filtros: '+p.join(' | '):'Mostrando todos';
  document.getElementById('badgeRecords').textContent=d.length+' registros';
  updKPIs(d);updGastoMes(d);updClasif(d);updTop10G(d);updTop10H(d);updHorasMes(d);updTipoServ(d);updComp(d);updTipoEq(d);updParetoG(d);updParetoH(d);updDesglose(d);
}

function updKPIs(d){
  const tG=d.reduce((s,r)=>s+r.total,0),tH=d.reduce((s,r)=>s+r.tiempo_estandar,0),tS=d.length,
  vU=new Set(d.map(r=>r.equipo)).size,aD=tS?d.reduce((s,r)=>s+r.dias_real,0)/tS:0,
  cA=d.filter(r=>r.dias_atraso>0).length;
  const k=[
    {l:'Gasto Total',v:fm(tG),i:'&#128176;',c:'var(--primary)',bg:'var(--primary-light)',sub:fm(tS?tG/tS:0)+' prom/serv'},
    {l:'Horas Totales',v:fn(tH),i:'&#9201;',c:'var(--teal)',bg:'var(--teal-light)',sub:(tS?(tH/tS).toFixed(1):0)+' hrs/serv'},
    {l:'Total Servicios',v:tS,i:'&#128295;',c:'var(--accent)',bg:'var(--accent-light)'},
    {l:'Vehiculos Unicos',v:vU,i:'&#128666;',c:'var(--orange)',bg:'var(--orange-light)'},
    {l:'Prom Dias/Serv',v:aD.toFixed(1),i:'&#128197;',c:'var(--green)',bg:'var(--green-light)'},
    {l:'Con Atraso',v:`${cA} (${tS?(cA/tS*100).toFixed(0):0}%)`,i:'&#9888;',c:'var(--red)',bg:'var(--red-light)'},
  ];
  document.getElementById('kpiGrid').innerHTML=k.map(x=>`<div class="kpi-card"><div class="kpi-icon" style="background:${x.bg};color:${x.c}">${x.i}</div><div class="kpi-info"><div class="kpi-label">${x.l}</div><div class="kpi-value" style="color:${x.c}">${x.v}</div>${x.sub?`<div class="kpi-sub">${x.sub}</div>`:''}</div></div>`).join('');
  document.getElementById('headerSubtitle').textContent=`${tS} servicios | ${vU} vehiculos | ${fm(tG)}`;
  document.getElementById('badgeTotalGasto').textContent=fm(tG);
}

function updGastoMes(d){dc('chartGastoMes');const g=gb(d,r=>`${MONTH_SHORT[r.mes]||r.mes} ${r.ano}`),p=sp(Object.keys(g));
  charts['chartGastoMes']=new Chart(document.getElementById('chartGastoMes'),{type:'bar',data:{labels:p,datasets:[{label:'Gasto ($)',data:p.map(x=>g[x].reduce((s,r)=>s+r.total,0)),backgroundColor:'#2563eb',borderRadius:8,order:2,yAxisID:'y'},{label:'Horas',data:p.map(x=>g[x].reduce((s,r)=>s+r.tiempo_estandar,0)),type:'line',borderColor:'#ea580c',backgroundColor:'rgba(234,88,12,0.1)',fill:true,tension:0.4,pointRadius:5,pointBackgroundColor:'#ea580c',borderWidth:3,order:1,yAxisID:'y1'}]},options:{responsive:true,interaction:{intersect:false,mode:'index'},plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:14}},datalabels:{display:false}},scales:{y:{position:'left',ticks:{callback:v=>fm(v)},grid:{color:'#f1f5f9'}},y1:{position:'right',ticks:{callback:v=>v+'h'},grid:{display:false}},x:{grid:{display:false}}}},plugins:[ChartDataLabels]});}

function updClasif(d){dc('chartClasif');const g=gb(d,r=>r.clasificacion||'Sin clasificar'),l=Object.keys(g).sort(),v=l.map(x=>g[x].length);
  document.getElementById('donutClasifValue').textContent=d.length;
  charts['chartClasif']=new Chart(document.getElementById('chartClasif'),{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:['#2563eb','#7c3aed','#0d9488','#ea580c'],borderWidth:0,hoverOffset:8}]},options:{cutout:'68%',responsive:true,plugins:{legend:{position:'bottom',labels:{usePointStyle:true,padding:10}},datalabels:{color:'#fff',font:{weight:'bold',size:13},formatter:(v,c)=>{const s=c.dataset.data.reduce((a,b)=>a+b,0);return((v/s)*100).toFixed(0)+'%';}}}},plugins:[ChartDataLabels]});}

function updTop10G(d){dc('chartTop10');const v={};d.forEach(r=>{v[r.equipo]=(v[r.equipo]||0)+r.total;});const s=Object.entries(v).sort((a,b)=>b[1]-a[1]).slice(0,10);
  charts['chartTop10']=new Chart(document.getElementById('chartTop10'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{data:s.map(x=>x[1]),backgroundColor:s.map((_,i)=>PALETTE[i%PALETTE.length]),borderRadius:6}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',color:'#1e293b',font:{weight:'bold',size:11},formatter:v=>fm(v)}},scales:{x:{ticks:{callback:v=>fm(v)},grid:{color:'#f1f5f9'}},y:{grid:{display:false}}}},plugins:[ChartDataLabels]});}

function updTop10H(d){dc('chartTop10Horas');const v={};d.forEach(r=>{v[r.equipo]=(v[r.equipo]||0)+r.tiempo_estandar;});const s=Object.entries(v).sort((a,b)=>b[1]-a[1]).slice(0,10);
  charts['chartTop10Horas']=new Chart(document.getElementById('chartTop10Horas'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{data:s.map(x=>x[1]),backgroundColor:s.map((_,i)=>PALETTE[(i+3)%PALETTE.length]),borderRadius:6}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',color:'#1e293b',font:{weight:'bold',size:11},formatter:v=>fn(v)+'h'}},scales:{x:{ticks:{callback:v=>v+'h'},grid:{color:'#f1f5f9'}},y:{grid:{display:false}}}},plugins:[ChartDataLabels]});}

function updHorasMes(d){dc('chartHorasMes');const g=gb(d,r=>`${MONTH_SHORT[r.mes]||r.mes} ${r.ano}`),p=sp(Object.keys(g)),tH=p.map(x=>g[x].reduce((s,r)=>s+r.tiempo_estandar,0));
  charts['chartHorasMes']=new Chart(document.getElementById('chartHorasMes'),{type:'bar',data:{labels:p,datasets:[{label:'Horas Totales',data:tH,backgroundColor:'#0d9488',borderRadius:8,yAxisID:'y'},{label:'Prom Hrs/Serv',data:p.map((x,i)=>g[x].length?tH[i]/g[x].length:0),type:'line',borderColor:'#7c3aed',backgroundColor:'rgba(124,58,237,0.1)',fill:true,tension:0.4,pointRadius:5,pointBackgroundColor:'#7c3aed',borderWidth:3,yAxisID:'y1'}]},options:{responsive:true,interaction:{intersect:false,mode:'index'},plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:14}},datalabels:{display:false}},scales:{y:{position:'left',ticks:{callback:v=>v+'h'},grid:{color:'#f1f5f9'}},y1:{position:'right',ticks:{callback:v=>v.toFixed(1)+'h'},grid:{display:false}},x:{grid:{display:false}}}},plugins:[ChartDataLabels]});}

function updTipoServ(d){dc('chartTipoServ');const g=gb(d,r=>r.tipo_servicio||'Sin tipo'),s=Object.entries(g).map(([k,v])=>[k,v.length]).sort((a,b)=>b[1]-a[1]);
  charts['chartTipoServ']=new Chart(document.getElementById('chartTipoServ'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{data:s.map(x=>x[1]),backgroundColor:PALETTE.slice(0,s.length),borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',color:'#1e293b',font:{weight:'bold',size:12}}},scales:{y:{grid:{color:'#f1f5f9'},beginAtZero:true},x:{grid:{display:false},ticks:{maxRotation:45,font:{size:9}}}}},plugins:[ChartDataLabels]});}

function updComp(d){const g=gb(d,r=>`${MONTH_SHORT[r.mes]||r.mes} ${r.ano}`),p=sp(Object.keys(g)),tb=document.querySelector('#tableComparativo tbody');
  tb.innerHTML=p.map(x=>{const rr=g[x],tG=rr.reduce((s,r)=>s+r.total,0),tH=rr.reduce((s,r)=>s+r.tiempo_estandar,0);return`<tr><td><strong>${x}</strong></td><td>${rr.length}</td><td class="money">${fmf(tG)}</td><td>${fn(tH)}h</td><td class="money">${fmf(rr.length?tG/rr.length:0)}</td><td>${rr.length?(tH/rr.length).toFixed(1):0}h</td></tr>`;}).join('');
  const tG=d.reduce((s,r)=>s+r.total,0),tH=d.reduce((s,r)=>s+r.tiempo_estandar,0);
  tb.innerHTML+=`<tr style="background:#f0f4f8;font-weight:700"><td>TOTAL</td><td>${d.length}</td><td class="money">${fmf(tG)}</td><td>${fn(tH)}h</td><td class="money">${fmf(d.length?tG/d.length:0)}</td><td>${d.length?(tH/d.length).toFixed(1):0}h</td></tr>`;}

function updTipoEq(d){dc('chartTipoEquipo');const g=gb(d,r=>r.tipo_equipo||'Sin tipo'),l=Object.keys(g).sort(),v=l.map(x=>g[x].length);
  document.getElementById('donutTipoValue').textContent=new Set(d.map(r=>r.equipo)).size;
  charts['chartTipoEquipo']=new Chart(document.getElementById('chartTipoEquipo'),{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:['#0d9488','#ea580c','#2563eb','#7c3aed'],borderWidth:0,hoverOffset:8}]},options:{cutout:'68%',responsive:true,plugins:{legend:{position:'bottom',labels:{usePointStyle:true,padding:10}},datalabels:{color:'#fff',font:{weight:'bold',size:13},formatter:(v,c)=>{const s=c.dataset.data.reduce((a,b)=>a+b,0);return((v/s)*100).toFixed(0)+'%';}}}},plugins:[ChartDataLabels]});}

function updParetoG(d){dc('chartPareto');const v={};d.forEach(r=>{v[r.equipo]=(v[r.equipo]||0)+r.total;});const s=Object.entries(v).sort((a,b)=>b[1]-a[1]),tG=s.reduce((a,e)=>a+e[1],0);let ac=0;const ap=s.map(([_,g])=>{ac+=g;return tG?ac/tG:0;}),cl=ap.map(p=>p<=0.8?'#dc2626':'#16a34a');
  charts['chartPareto']=new Chart(document.getElementById('chartPareto'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{label:'Gasto',data:s.map(x=>x[1]),backgroundColor:cl,borderRadius:4,order:2,yAxisID:'y'},{label:'% Acumulado',data:ap.map(p=>p*100),type:'line',borderColor:'#1e293b',borderWidth:3,pointRadius:4,pointBackgroundColor:'#1e293b',fill:false,order:1,yAxisID:'y1'}]},options:{responsive:true,interaction:{intersect:false,mode:'index'},plugins:{legend:{position:'top',labels:{usePointStyle:true}},datalabels:{display:false}},scales:{y:{position:'left',ticks:{callback:v=>fm(v)},grid:{color:'#f1f5f9'}},y1:{position:'right',min:0,max:100,ticks:{callback:v=>v+'%'},grid:{display:false}},x:{grid:{display:false},ticks:{maxRotation:45,font:{size:9}}}}},plugins:[ChartDataLabels]});
  const tb=document.querySelector('#tablePareto tbody');ac=0;
  tb.innerHTML=s.map(([vh,g],i)=>{ac+=g;const pA=tG?ac/tG:0,vi=pA<=0.8;return`<tr><td><span class="rank ${i<3?'rank-'+(i+1):'rank-default'}">${i+1}</span></td><td>${vh}</td><td class="money">${fmf(g)}</td><td>${fp(pA)}</td><td><span class="pareto-tag ${vi?'pareto-vital':'pareto-trivial'}">${vi?'80% Vital':'20% Trivial'}</span></td></tr>`;}).join('');}

function updParetoH(d){dc('chartParetoHoras');const v={};d.forEach(r=>{v[r.equipo]=(v[r.equipo]||0)+r.tiempo_estandar;});const s=Object.entries(v).sort((a,b)=>b[1]-a[1]),tH=s.reduce((a,e)=>a+e[1],0);let ac=0;const ap=s.map(([_,h])=>{ac+=h;return tH?ac/tH:0;}),cl=ap.map(p=>p<=0.8?'#ea580c':'#0d9488');
  charts['chartParetoHoras']=new Chart(document.getElementById('chartParetoHoras'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{label:'Horas',data:s.map(x=>x[1]),backgroundColor:cl,borderRadius:4,order:2,yAxisID:'y'},{label:'% Acumulado',data:ap.map(p=>p*100),type:'line',borderColor:'#1e293b',borderWidth:3,pointRadius:4,pointBackgroundColor:'#1e293b',fill:false,order:1,yAxisID:'y1'}]},options:{responsive:true,interaction:{intersect:false,mode:'index'},plugins:{legend:{position:'top',labels:{usePointStyle:true}},datalabels:{display:false}},scales:{y:{position:'left',ticks:{callback:v=>v+'h'},grid:{color:'#f1f5f9'}},y1:{position:'right',min:0,max:100,ticks:{callback:v=>v+'%'},grid:{display:false}},x:{grid:{display:false},ticks:{maxRotation:45,font:{size:9}}}}},plugins:[ChartDataLabels]});}

function updDesglose(d){dc('chartDesglose');const g=gb(d,r=>`${MONTH_SHORT[r.mes]||r.mes} ${r.ano}`),p=sp(Object.keys(g));
  charts['chartDesglose']=new Chart(document.getElementById('chartDesglose'),{type:'bar',data:{labels:p,datasets:[{label:'Refacciones',data:p.map(x=>g[x].reduce((s,r)=>s+r.precio_refaccion,0)),backgroundColor:'#2563eb',borderRadius:4,stack:'a'},{label:'Mano de Obra',data:p.map(x=>g[x].reduce((s,r)=>s+r.precio_mano_obra,0)),backgroundColor:'#7c3aed',borderRadius:4,stack:'a'},{label:'Otros Talleres',data:p.map(x=>g[x].reduce((s,r)=>s+r.precio_otros,0)),backgroundColor:'#ea580c',borderRadius:4,stack:'a'}]},options:{responsive:true,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:14}},datalabels:{display:false}},scales:{y:{stacked:true,ticks:{callback:v=>fm(v)},grid:{color:'#f1f5f9'}},x:{stacked:true,grid:{display:false}}}},plugins:[ChartDataLabels]});}

// ══════════════════════════════════════
// INIT
// ══════════════════════════════════════
document.addEventListener('DOMContentLoaded', async () => {
  await loadFromOneDrive();
  setTimeout(()=>document.getElementById('loading').classList.add('hide'),500);
});
</script>
</body>
</html>
