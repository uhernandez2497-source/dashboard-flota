<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ejecutivo - Mantenimiento de Flota</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  :root{--bg:#f0f4f8;--card:#fff;--primary:#2563eb;--primary-light:#dbeafe;--primary-dark:#1e40af;--accent:#7c3aed;--accent-light:#ede9fe;--teal:#0d9488;--teal-light:#ccfbf1;--orange:#ea580c;--orange-light:#fff7ed;--red:#dc2626;--red-light:#fef2f2;--green:#16a34a;--green-light:#f0fdf4;--text:#1e293b;--text-sec:#64748b;--text-m:#94a3b8;--border:#e2e8f0;--shadow:0 1px 3px rgba(0,0,0,.06),0 4px 12px rgba(0,0,0,.04);--shadow-lg:0 4px 24px rgba(0,0,0,.08);--radius:16px}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  .header{background:linear-gradient(135deg,var(--primary-dark),var(--primary) 50%,var(--accent));padding:18px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(37,99,235,.3)}
  .header-left{display:flex;align-items:center;gap:14px}
  .header-logo{width:40px;height:40px;background:rgba(255,255,255,.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
  .header h1{color:#fff;font-size:18px;font-weight:700}
  .header p{color:rgba(255,255,255,.7);font-size:11px;margin-top:1px}
  .header-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .hbadge{background:rgba(255,255,255,.15);color:#fff;padding:4px 10px;border-radius:16px;font-size:10px;font-weight:500;display:flex;align-items:center;gap:5px}
  .status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;animation:pulse 2s infinite}
  .status-dot.ok{background:#4ade80}.status-dot.loading{background:#facc15}.status-dot.error{background:#f87171}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .hbtn{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);padding:5px 12px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit;display:flex;align-items:center;gap:5px}
  .hbtn:hover{background:rgba(255,255,255,.35)}
  .hbtn.spinning svg{animation:spin .8s linear infinite}
  .hbtn.pdf-btn{background:rgba(220,38,38,.8);border-color:rgba(220,38,38,.9)}
  .hbtn.pdf-btn:hover{background:rgba(220,38,38,1)}
  @keyframes spin{to{transform:rotate(360deg)}}

  .filters-bar{background:var(--card);padding:12px 32px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);flex-wrap:wrap;box-shadow:0 2px 8px rgba(0,0,0,.03)}
  .fg{display:flex;align-items:center;gap:5px}
  .fl{font-size:10px;font-weight:700;color:var(--text-sec);text-transform:uppercase;letter-spacing:.5px}
  .fbtns{display:flex;gap:3px;flex-wrap:wrap}
  .fbtn{padding:4px 10px;border:1.5px solid var(--border);background:#fff;border-radius:7px;font-size:10px;font-weight:500;color:var(--text-sec);cursor:pointer;transition:all .2s;font-family:inherit}
  .fbtn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
  .fbtn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 2px 8px rgba(37,99,235,.3)}
  .fdiv{width:1px;height:24px;background:var(--border);margin:0 3px}
  .freset{padding:4px 10px;border:none;background:var(--red-light);color:var(--red);border-radius:7px;font-size:10px;font-weight:700;cursor:pointer;font-family:inherit}
  .freset:hover{background:var(--red);color:#fff}
  .finfo{font-size:10px;color:var(--text-m);margin-left:auto}

  .main{padding:20px 32px;max-width:1500px;margin:0 auto}
  .conn-banner{border-radius:10px;padding:8px 16px;display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:11px;background:linear-gradient(90deg,#ecfdf5,#f0fdf4);border:1px solid #86efac;color:#166534}
  .conn-banner.error{background:linear-gradient(90deg,#fef2f2,#fff1f2);border-color:#fca5a5;color:#991b1b}
  .conn-banner.loading{background:linear-gradient(90deg,#fffbeb,#fef9c3);border-color:#fde047;color:#854d0e}

  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:18px}
  .kpi-card{background:var(--card);border-radius:14px;padding:14px 16px;box-shadow:var(--shadow);display:flex;align-items:flex-start;gap:12px;transition:transform .2s}
  .kpi-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
  .kpi-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
  .kpi-label{font-size:10px;font-weight:700;color:var(--text-m);text-transform:uppercase;letter-spacing:.4px}
  .kpi-value{font-size:20px;font-weight:800;margin:2px 0;letter-spacing:-.5px;line-height:1.1}
  .kpi-sub{font-size:10px;font-weight:600;color:var(--text-m)}

  .grid{display:grid;gap:14px;margin-bottom:18px}
  .g2{grid-template-columns:1fr 1fr}.g21{grid-template-columns:5fr 3fr}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .card:hover{box-shadow:var(--shadow-lg)}
  .ch{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .ct{font-size:13px;font-weight:700}.cs{font-size:10px;color:var(--text-m);margin-top:1px}
  .cb{font-size:10px;font-weight:600;padding:3px 8px;border-radius:5px}

  .tbl{width:100%;border-collapse:separate;border-spacing:0}
  .tbl thead th{background:#f8fafc;padding:6px 10px;text-align:left;font-size:9px;font-weight:700;color:var(--text-m);text-transform:uppercase;letter-spacing:.4px;border-bottom:2px solid var(--border);position:sticky;top:0}
  .tbl tbody td{padding:6px 10px;font-size:11px;border-bottom:1px solid #f1f5f9}
  .tbl tbody tr:hover{background:#f8fafc}
  .tbl .money{font-weight:600;font-variant-numeric:tabular-nums}
  .rank{width:22px;height:22px;border-radius:5px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:10px}
  .rank-1{background:#fef3c7;color:#b45309}.rank-2{background:#e2e8f0;color:#475569}.rank-3{background:#fed7aa;color:#c2410c}.rank-d{background:#f1f5f9;color:var(--text-sec)}
  .ptag{padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700}
  .pv{background:#fef2f2;color:#dc2626}.pt{background:#f0fdf4;color:#16a34a}
  .dw{position:relative;display:flex;justify-content:center}
  .dc{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
  .dcv{font-size:22px;font-weight:800;color:var(--text)}.dcl{font-size:9px;color:var(--text-m)}
  .stitle{font-size:14px;font-weight:700;color:var(--text);margin:22px 0 10px;display:flex;align-items:center;gap:8px}
  .stitle::before{content:'';width:4px;height:20px;background:var(--primary);border-radius:2px}

  @media(max-width:1100px){.g2,.g21{grid-template-columns:1fr}.main{padding:14px}.header,.filters-bar{padding-left:14px;padding-right:14px}}
  @media(max-width:768px){.kpi-grid{grid-template-columns:repeat(2,1fr)}.kpi-value{font-size:16px}}

  .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s;gap:14px}
  .loading-overlay.hide{opacity:0;pointer-events:none}
  .spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
  .ltxt{font-size:13px;color:var(--text-sec);font-weight:500}
  ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
  footer{text-align:center;padding:20px 0;color:var(--text-m);font-size:10px}

</style>
</head>
<body>
<div class="loading-overlay" id="loading"><div class="spinner"></div><div class="ltxt" id="loadingText">Conectando con OneDrive...</div></div>


<div class="header">
  <div class="header-left">
    <div class="header-logo">&#9881;</div>
    <div><h1>Dashboard Ejecutivo - Mantenimiento</h1><p id="headerSub">Conectado a OneDrive</p></div>
  </div>
  <div class="header-right">
    <div class="hbadge"><span class="status-dot loading" id="sDot"></span><span id="sTxt">Conectando...</span></div>
    <div class="hbadge" id="bRec">-- registros</div>
    <div class="hbadge" id="bUpd">Sin actualizar</div>
    <button class="hbtn" id="refreshBtn" onclick="refreshData()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0118.8-4.3M22 12.5a10 10 0 01-18.8 4.3"/></svg>Actualizar
    </button>
    <button class="hbtn pdf-btn" onclick="generateSummary()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Resumen
    </button>
  </div>
</div>

<div class="filters-bar">
  <div class="fg"><span class="fl">Ano:</span><div class="fbtns" id="fY"></div></div><div class="fdiv"></div>
  <div class="fg"><span class="fl">Mes:</span><div class="fbtns" id="fM"></div></div><div class="fdiv"></div>
  <div class="fg"><span class="fl">Tipo:</span><div class="fbtns" id="fT"></div></div><div class="fdiv"></div>
  <div class="fg"><span class="fl">Clasif:</span><div class="fbtns" id="fC"></div></div><div class="fdiv"></div>
  <button class="freset" onclick="resetF()">&#x21bb; Limpiar</button>
  <span class="finfo" id="fInfo"></span>
</div>

<div class="main" id="dashContent">
  <div class="conn-banner loading" id="cBanner"><span style="font-size:16px">&#9889;</span><div><strong>OneDrive</strong> &mdash; <span id="cMsg">Conectando...</span></div></div>
  <div class="kpi-grid" id="kpiGrid"></div>

  <div class="grid g21">
    <div class="card"><div class="ch"><div><div class="ct">Gasto por Mes</div><div class="cs">Tendencia mensual + horas</div></div><div class="cb" style="background:var(--primary-light);color:var(--primary)" id="bGasto">--</div></div><canvas id="cGastoMes" height="280"></canvas></div>
    <div class="card"><div class="ch"><div><div class="ct">Clasificacion</div><div class="cs">Correctivo vs Preventivo</div></div></div><div class="dw"><canvas id="cClasif" height="280"></canvas><div class="dc"><div class="dcv" id="dClV">--</div><div class="dcl">Servicios</div></div></div></div>
  </div>

  <div class="stitle">Analisis por Vehiculo</div>
  <div class="grid g2">
    <div class="card"><div class="ch"><div><div class="ct">Top 10 Vehiculos - Mayor Gasto</div><div class="cs">Mayor inversion en mantenimiento</div></div></div><canvas id="cTop10" height="280"></canvas></div>
    <div class="card"><div class="ch"><div><div class="ct">Top 10 Vehiculos - Horas Consumidas</div><div class="cs">Mayor consumo de tiempo</div></div></div><canvas id="cTop10H" height="280"></canvas></div>
  </div>

  <div class="stitle">Tendencias y Comparativos</div>
  <div class="grid g2">
    <div class="card"><div class="ch"><div><div class="ct">Consumo de Horas por Mes</div><div class="cs">Horas y promedio por servicio</div></div></div><canvas id="cHorasMes" height="280"></canvas></div>
    <div class="card"><div class="ch"><div><div class="ct">Servicios por Tipo</div><div class="cs">Distribucion por tipo</div></div></div><canvas id="cTipoServ" height="280"></canvas></div>
  </div>

  <div class="grid g21">
    <div class="card"><div class="ch"><div><div class="ct">Comparativo Mensual</div><div class="cs">Gasto, horas y servicios</div></div></div><div style="overflow-x:auto"><table class="tbl" id="tComp"><thead><tr><th>Periodo</th><th>Servicios</th><th>Gasto Total</th><th>Horas</th><th>$/Serv</th><th>Hrs/Serv</th></tr></thead><tbody></tbody></table></div></div>
    <div class="card"><div class="ch"><div><div class="ct">Tipo de Equipo</div><div class="cs">Distribucion de flota</div></div></div><div class="dw"><canvas id="cTipoEq" height="280"></canvas><div class="dc"><div class="dcv" id="dTeV">--</div><div class="dcl">Equipos</div></div></div></div>
  </div>

  <div class="stitle">Analisis de Pareto 80/20</div>
  <div class="grid g2">
    <div class="card"><div class="ch"><div><div class="ct">Pareto de Gasto</div><div class="cs">20% que genera 80% del gasto</div></div></div><canvas id="cPareto" height="280"></canvas></div>
    <div class="card"><div class="ch"><div><div class="ct">Detalle Pareto</div><div class="cs">Acumulado y zona 80/20</div></div></div><div style="overflow-x:auto;max-height:340px;overflow-y:auto"><table class="tbl" id="tPareto"><thead><tr><th>#</th><th>Vehiculo</th><th>Gasto</th><th>% Acum.</th><th>Zona</th></tr></thead><tbody></tbody></table></div></div>
  </div>
  <div class="grid g2">
    <div class="card"><div class="ch"><div><div class="ct">Pareto de Horas</div><div class="cs">20% que consume 80% horas</div></div></div><canvas id="cParetoH" height="280"></canvas></div>
    <div class="card"><div class="ch"><div><div class="ct">Desglose de Costos</div><div class="cs">Refacciones vs Mano Obra vs Otros</div></div></div><canvas id="cDesglose" height="280"></canvas></div>
  </div>
  <footer>Dashboard Ejecutivo de Mantenimiento &bull; Datos desde OneDrive &bull; Click Actualizar para refrescar<br><span id="fTs"></span></footer>
</div>

<script>
const ONEDRIVE_DL='https://proxylogis-my.sharepoint.com/personal/carlosu_hernandez_mecanicatek_com/_layouts/15/download.aspx?share=IQD1veTLe2bTQIoFUNNe7y3yAUzwHQ-2YN3uHUdOc4vF8Fs';
const PROXIES=[u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,u=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,u=>`https://corsproxy.org/?${encodeURIComponent(u)}`];
const COL={equipo:4,tipo_equipo:8,marca:10,modelo:11,razon:13,refaccion:32,mano_obra:33,otros:34,total:35,dias_real:40,dias_atraso:41,nodo:45,region:46,clasificacion:63,tipo_servicio:64,tiempo:68,familia:69,mes:70,ano:71,grupo:7};
const MO={enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,julio:7,agosto:8,septiembre:9,octubre:10,noviembre:11,diciembre:12};
const MS={enero:'Ene',febrero:'Feb',marzo:'Mar',abril:'Abr',mayo:'May',junio:'Jun',julio:'Jul',agosto:'Ago',septiembre:'Sep',octubre:'Oct',noviembre:'Nov',diciembre:'Dic'};
const PAL=['#2563eb','#7c3aed','#0d9488','#ea580c','#dc2626','#16a34a','#d946ef','#0284c7','#ca8a04','#be185d','#6366f1','#059669'];
let RAW=[],F={year:'all',month:'all',tipo:'all',clasif:'all'},CH={};

// ── LOAD ──
async function loadFromOneDrive(){
  setSt('loading','Descargando Excel de OneDrive...');
  document.getElementById('refreshBtn').classList.add('spinning');
  let ab=null;
  for(let i=0;i<PROXIES.length;i++){
    try{setSt('loading',`Proxy ${i+1}/${PROXIES.length}...`);const ac=new AbortController();const tid=setTimeout(()=>ac.abort(),3000);const r=await fetch(PROXIES[i](ONEDRIVE_DL),{headers:{'X-Requested-With':'XMLHttpRequest'},signal:ac.signal});clearTimeout(tid);if(!r.ok)throw new Error(`HTTP ${r.status}`);ab=await r.arrayBuffer();if(ab.byteLength<1000)throw new Error('Too small');break;}
    catch(e){console.warn(`Proxy ${i+1}:`,e.message);if(i===PROXIES.length-1){setSt('error','No se pudo conectar a OneDrive.');document.getElementById('refreshBtn').classList.remove('spinning');return;}}
  }
  try{
    setSt('loading','Parseando Excel...');
    const wb=XLSX.read(new Uint8Array(ab),{type:'array'}),ws=wb.Sheets['bd']||wb.Sheets[wb.SheetNames[0]],rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    RAW=[];
    for(let i=1;i<rows.length;i++){const r=rows[i];if(!r[COL.equipo])continue;const sf=v=>{const n=parseFloat(v);return isNaN(n)?0:n},ss=v=>v==null?'':String(v).trim();
      RAW.push({equipo:ss(r[COL.equipo]),tipo_equipo:ss(r[COL.tipo_equipo]),marca:ss(r[COL.marca]),modelo:ss(r[COL.modelo]),razon_reparacion:ss(r[COL.razon]),precio_refaccion:sf(r[COL.refaccion]),precio_mano_obra:sf(r[COL.mano_obra]),precio_otros:sf(r[COL.otros]),total:sf(r[COL.total]),dias_real:sf(r[COL.dias_real]),dias_atraso:sf(r[COL.dias_atraso]),nodo:ss(r[COL.nodo]),region:ss(r[COL.region]),clasificacion:ss(r[COL.clasificacion]),tipo_servicio:ss(r[COL.tipo_servicio]),tiempo_estandar:sf(r[COL.tiempo]),familia:ss(r[COL.familia]),mes:ss(r[COL.mes]).toLowerCase(),ano:ss(r[COL.ano]),grupo_manto:ss(r[COL.grupo])});}
    const ts=new Date().toLocaleString('es-MX');
    setSt('ok',`${RAW.length} registros | ${ts}`);
    document.getElementById('bUpd').textContent=ts;
    document.getElementById('fTs').textContent=`Ultima carga: ${ts} | ${(ab.byteLength/1024).toFixed(0)} KB`;
    try{localStorage.setItem('dashRAW',JSON.stringify(RAW));localStorage.setItem('dashTS',ts);}catch(e){}
    setupF();updateAll();
  }catch(e){setSt('error','Error: '+e.message);}
  document.getElementById('refreshBtn').classList.remove('spinning');
}
function setSt(s,m){document.getElementById('sDot').className=`status-dot ${s}`;document.getElementById('cBanner').className=`conn-banner ${s==='ok'?'':s}`;document.getElementById('sTxt').textContent={ok:'Conectado',loading:'Cargando...',error:'Error'}[s]||s;document.getElementById('cMsg').textContent=m;document.getElementById('loadingText').textContent=m;}

// ── LOAD FROM LOCAL JSON (no CORS, always works) ──
async function loadFromJSON(){
  setSt('loading','Cargando datos locales...');
  try{
    const r=await fetch('data.json?cb='+Date.now(),{cache:'no-store'});if(!r.ok)throw new Error('HTTP '+r.status);
    const json=await r.json();const records=json.data||json;
    if(!Array.isArray(records)||!records.length)throw new Error('Sin registros');
    RAW=records;
    const ts=json.updated?new Date(json.updated).toLocaleString('es-MX'):'data.json';
    setSt('ok',RAW.length+' registros | '+ts);
    document.getElementById('bUpd').textContent=ts;
    document.getElementById('fTs').textContent='Datos desde data.json | '+RAW.length+' registros | '+ts;
    try{localStorage.setItem('dashRAW',JSON.stringify(RAW));localStorage.setItem('dashTS',ts);}catch(e){}
    setupF();updateAll();return true;
  }catch(e){console.warn('loadFromJSON:',e.message);return false;}
}

// ── REFRESH: OneDrive -> data.json fallback ──
async function refreshData(){
  await loadFromOneDrive();
  if(!RAW.length){await loadFromJSON();}
}

// ── FILTERS ──
function setupF(){
  const y=[...new Set(RAW.map(r=>r.ano))].filter(Boolean).sort(),m=[...new Set(RAW.map(r=>r.mes))].filter(Boolean).sort((a,b)=>(MO[a]||99)-(MO[b]||99)),t=[...new Set(RAW.map(r=>r.tipo_equipo))].filter(Boolean).sort(),c=[...new Set(RAW.map(r=>r.clasificacion))].filter(Boolean).sort();
  rB('fY','year',y,v=>v);rB('fM','month',m,v=>cap(v));rB('fT','tipo',t,v=>v);rB('fC','clasif',c,v=>v);
}
function rB(id,k,vs,fn){const el=document.getElementById(id),cu=F[k];let h=`<button class="fbtn ${cu==='all'?'active':''}" data-f="${k}" data-v="all" onclick="sF('${k}','all')">Todos</button>`;vs.forEach(v=>{h+=`<button class="fbtn ${cu===v?'active':''}" data-f="${k}" data-v="${v}" onclick="sF('${k}','${v}')">${fn(v)}</button>`;});el.innerHTML=h;}
function sF(k,v){F[k]=v;document.querySelectorAll(`[data-f="${k}"]`).forEach(b=>b.classList.toggle('active',b.dataset.v===v));updateAll();}
function resetF(){F={year:'all',month:'all',tipo:'all',clasif:'all'};setupF();updateAll();}
function gF(){return RAW.filter(r=>{if(F.year!=='all'&&r.ano!==F.year)return!1;if(F.month!=='all'&&r.mes!==F.month)return!1;if(F.tipo!=='all'&&r.tipo_equipo!==F.tipo)return!1;if(F.clasif!=='all'&&r.clasificacion!==F.clasif)return!1;return!0;});}
function getFilterDesc(){const p=[];if(F.year!=='all')p.push('Ano: '+F.year);if(F.month!=='all')p.push('Mes: '+cap(F.month));if(F.tipo!=='all')p.push('Tipo: '+F.tipo);if(F.clasif!=='all')p.push('Clasif: '+F.clasif);return p.length?p.join(' | '):'Sin filtros (todos los datos)';}

// ── UTILS ──
function cap(s){return s?s[0].toUpperCase()+s.slice(1):'';}
function fm(v){return'$'+v.toLocaleString('es-MX',{minimumFractionDigits:0,maximumFractionDigits:0});}
function fmf(v){return'$'+v.toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fn(v){return v.toLocaleString('es-MX',{maximumFractionDigits:1});}
function fp(v){return(v*100).toFixed(1)+'%';}
function gb(d,f){const m={};d.forEach(r=>{const k=f(r);if(!m[k])m[k]=[];m[k].push(r);});return m;}
function dc(id){if(CH[id]){CH[id].destroy();delete CH[id];}}
function sp(k){const mo={Ene:1,Feb:2,Mar:3,Abr:4,May:5,Jun:6,Jul:7,Ago:8,Sep:9,Oct:10,Nov:11,Dic:12};return k.sort((a,b)=>{const[ma,ya]=[a.split(' ')[0],a.split(' ')[1]],[mb,yb]=[b.split(' ')[0],b.split(' ')[1]];return(ya-yb)||((mo[ma]||0)-(mo[mb]||0));});}

// ── DASHBOARD ──
function updateAll(){
  const d=gF();
  document.getElementById('fInfo').textContent=getFilterDesc();
  document.getElementById('bRec').textContent=d.length+' reg';
  uKPI(d);uGM(d);uCl(d);uT10G(d);uT10H(d);uHM(d);uTS(d);uComp(d);uTE(d);uPG(d);uPH(d);uDsg(d);
}

function uKPI(d){
  const tG=d.reduce((s,r)=>s+r.total,0),tH=d.reduce((s,r)=>s+r.tiempo_estandar,0),tS=d.length,vU=new Set(d.map(r=>r.equipo)).size,aD=tS?d.reduce((s,r)=>s+r.dias_real,0)/tS:0,cA=d.filter(r=>r.dias_atraso>0).length;
  const k=[{l:'Gasto Total',v:fm(tG),i:'&#128176;',c:'var(--primary)',bg:'var(--primary-light)',sub:fm(tS?tG/tS:0)+'/serv'},{l:'Horas Totales',v:fn(tH),i:'&#9201;',c:'var(--teal)',bg:'var(--teal-light)',sub:(tS?(tH/tS).toFixed(1):0)+' hrs/serv'},{l:'Servicios',v:tS,i:'&#128295;',c:'var(--accent)',bg:'var(--accent-light)'},{l:'Vehiculos',v:vU,i:'&#128666;',c:'var(--orange)',bg:'var(--orange-light)'},{l:'Prom Dias',v:aD.toFixed(1),i:'&#128197;',c:'var(--green)',bg:'var(--green-light)'},{l:'Con Atraso',v:`${cA} (${tS?(cA/tS*100).toFixed(0):0}%)`,i:'&#9888;',c:'var(--red)',bg:'var(--red-light)'}];
  document.getElementById('kpiGrid').innerHTML=k.map(x=>`<div class="kpi-card"><div class="kpi-icon" style="background:${x.bg};color:${x.c}">${x.i}</div><div><div class="kpi-label">${x.l}</div><div class="kpi-value" style="color:${x.c}">${x.v}</div>${x.sub?`<div class="kpi-sub">${x.sub}</div>`:''}</div></div>`).join('');
  document.getElementById('headerSub').textContent=`${tS} servicios | ${vU} vehiculos | ${fm(tG)}`;
  document.getElementById('bGasto').textContent=fm(tG);
}

function uGM(d){dc('cGastoMes');const g=gb(d,r=>`${MS[r.mes]||r.mes} ${r.ano}`),p=sp(Object.keys(g));
  CH['cGastoMes']=new Chart(document.getElementById('cGastoMes'),{type:'bar',data:{labels:p,datasets:[{label:'Gasto ($)',data:p.map(x=>g[x].reduce((s,r)=>s+r.total,0)),backgroundColor:'#2563eb',borderRadius:6,order:2,yAxisID:'y'},{label:'Horas',data:p.map(x=>g[x].reduce((s,r)=>s+r.tiempo_estandar,0)),type:'line',borderColor:'#ea580c',backgroundColor:'rgba(234,88,12,.1)',fill:!0,tension:.4,pointRadius:4,pointBackgroundColor:'#ea580c',borderWidth:2.5,order:1,yAxisID:'y1'}]},options:{responsive:!0,interaction:{intersect:!1,mode:'index'},plugins:{legend:{position:'top',labels:{usePointStyle:!0,padding:12,font:{size:10}}},datalabels:{display:!1}},scales:{y:{position:'left',ticks:{callback:v=>fm(v),font:{size:9}},grid:{color:'#f1f5f9'}},y1:{position:'right',ticks:{callback:v=>v+'h',font:{size:9}},grid:{display:!1}},x:{grid:{display:!1},ticks:{font:{size:9}}}}},plugins:[ChartDataLabels]});}

function uCl(d){dc('cClasif');const g=gb(d,r=>r.clasificacion||'Sin clasificar'),l=Object.keys(g).sort(),v=l.map(x=>g[x].length);document.getElementById('dClV').textContent=d.length;
  CH['cClasif']=new Chart(document.getElementById('cClasif'),{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:['#2563eb','#7c3aed','#0d9488','#ea580c'],borderWidth:0,hoverOffset:6}]},options:{cutout:'68%',responsive:!0,plugins:{legend:{position:'bottom',labels:{usePointStyle:!0,padding:8,font:{size:10}}},datalabels:{color:'#fff',font:{weight:'bold',size:12},formatter:(v,c)=>{const s=c.dataset.data.reduce((a,b)=>a+b,0);return((v/s)*100).toFixed(0)+'%';}}}},plugins:[ChartDataLabels]});}

function uT10G(d){dc('cTop10');const v={};d.forEach(r=>{v[r.equipo]=(v[r.equipo]||0)+r.total;});const s=Object.entries(v).sort((a,b)=>b[1]-a[1]).slice(0,10);
  CH['cTop10']=new Chart(document.getElementById('cTop10'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{data:s.map(x=>x[1]),backgroundColor:s.map((_,i)=>PAL[i%PAL.length]),borderRadius:5}]},options:{indexAxis:'y',responsive:!0,plugins:{legend:{display:!1},datalabels:{anchor:'end',align:'end',color:'#1e293b',font:{weight:'bold',size:10},formatter:v=>fm(v)}},scales:{x:{ticks:{callback:v=>fm(v),font:{size:9}},grid:{color:'#f1f5f9'}},y:{grid:{display:!1},ticks:{font:{size:9}}}}},plugins:[ChartDataLabels]});}

function uT10H(d){dc('cTop10H');const v={};d.forEach(r=>{v[r.equipo]=(v[r.equipo]||0)+r.tiempo_estandar;});const s=Object.entries(v).sort((a,b)=>b[1]-a[1]).slice(0,10);
  CH['cTop10H']=new Chart(document.getElementById('cTop10H'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{data:s.map(x=>x[1]),backgroundColor:s.map((_,i)=>PAL[(i+3)%PAL.length]),borderRadius:5}]},options:{indexAxis:'y',responsive:!0,plugins:{legend:{display:!1},datalabels:{anchor:'end',align:'end',color:'#1e293b',font:{weight:'bold',size:10},formatter:v=>fn(v)+'h'}},scales:{x:{ticks:{callback:v=>v+'h',font:{size:9}},grid:{color:'#f1f5f9'}},y:{grid:{display:!1},ticks:{font:{size:9}}}}},plugins:[ChartDataLabels]});}

function uHM(d){dc('cHorasMes');const g=gb(d,r=>`${MS[r.mes]||r.mes} ${r.ano}`),p=sp(Object.keys(g)),tH=p.map(x=>g[x].reduce((s,r)=>s+r.tiempo_estandar,0));
  CH['cHorasMes']=new Chart(document.getElementById('cHorasMes'),{type:'bar',data:{labels:p,datasets:[{label:'Horas Totales',data:tH,backgroundColor:'#0d9488',borderRadius:6,yAxisID:'y'},{label:'Prom Hrs/Serv',data:p.map((x,i)=>g[x].length?tH[i]/g[x].length:0),type:'line',borderColor:'#7c3aed',backgroundColor:'rgba(124,58,237,.1)',fill:!0,tension:.4,pointRadius:4,pointBackgroundColor:'#7c3aed',borderWidth:2.5,yAxisID:'y1'}]},options:{responsive:!0,interaction:{intersect:!1,mode:'index'},plugins:{legend:{position:'top',labels:{usePointStyle:!0,padding:12,font:{size:10}}},datalabels:{display:!1}},scales:{y:{position:'left',ticks:{callback:v=>v+'h',font:{size:9}},grid:{color:'#f1f5f9'}},y1:{position:'right',ticks:{callback:v=>v.toFixed(1)+'h',font:{size:9}},grid:{display:!1}},x:{grid:{display:!1},ticks:{font:{size:9}}}}},plugins:[ChartDataLabels]});}

function uTS(d){dc('cTipoServ');const g=gb(d,r=>r.tipo_servicio||'Sin tipo'),s=Object.entries(g).map(([k,v])=>[k,v.length]).sort((a,b)=>b[1]-a[1]);
  CH['cTipoServ']=new Chart(document.getElementById('cTipoServ'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{data:s.map(x=>x[1]),backgroundColor:PAL.slice(0,s.length),borderRadius:5}]},options:{responsive:!0,plugins:{legend:{display:!1},datalabels:{anchor:'end',align:'top',color:'#1e293b',font:{weight:'bold',size:10}}},scales:{y:{grid:{color:'#f1f5f9'},beginAtZero:!0,ticks:{font:{size:9}}},x:{grid:{display:!1},ticks:{maxRotation:45,font:{size:8}}}}},plugins:[ChartDataLabels]});}

function uComp(d){const g=gb(d,r=>`${MS[r.mes]||r.mes} ${r.ano}`),p=sp(Object.keys(g)),tb=document.querySelector('#tComp tbody');
  tb.innerHTML=p.map(x=>{const rr=g[x],tG=rr.reduce((s,r)=>s+r.total,0),tH=rr.reduce((s,r)=>s+r.tiempo_estandar,0);return`<tr><td><strong>${x}</strong></td><td>${rr.length}</td><td class="money">${fmf(tG)}</td><td>${fn(tH)}h</td><td class="money">${fmf(rr.length?tG/rr.length:0)}</td><td>${rr.length?(tH/rr.length).toFixed(1):0}h</td></tr>`;}).join('');
  const tG=d.reduce((s,r)=>s+r.total,0),tH=d.reduce((s,r)=>s+r.tiempo_estandar,0);
  tb.innerHTML+=`<tr style="background:#f0f4f8;font-weight:700"><td>TOTAL</td><td>${d.length}</td><td class="money">${fmf(tG)}</td><td>${fn(tH)}h</td><td class="money">${fmf(d.length?tG/d.length:0)}</td><td>${d.length?(tH/d.length).toFixed(1):0}h</td></tr>`;}

function uTE(d){dc('cTipoEq');const g=gb(d,r=>r.tipo_equipo||'Sin tipo'),l=Object.keys(g).sort(),v=l.map(x=>g[x].length);document.getElementById('dTeV').textContent=new Set(d.map(r=>r.equipo)).size;
  CH['cTipoEq']=new Chart(document.getElementById('cTipoEq'),{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:['#0d9488','#ea580c','#2563eb','#7c3aed'],borderWidth:0,hoverOffset:6}]},options:{cutout:'68%',responsive:!0,plugins:{legend:{position:'bottom',labels:{usePointStyle:!0,padding:8,font:{size:10}}},datalabels:{color:'#fff',font:{weight:'bold',size:12},formatter:(v,c)=>{const s=c.dataset.data.reduce((a,b)=>a+b,0);return((v/s)*100).toFixed(0)+'%';}}}},plugins:[ChartDataLabels]});}

function uPG(d){dc('cPareto');const v={};d.forEach(r=>{v[r.equipo]=(v[r.equipo]||0)+r.total;});const s=Object.entries(v).sort((a,b)=>b[1]-a[1]),tG=s.reduce((a,e)=>a+e[1],0);let ac=0;const ap=s.map(([_,g])=>{ac+=g;return tG?ac/tG:0;}),cl=ap.map(p=>p<=.8?'#dc2626':'#16a34a');
  CH['cPareto']=new Chart(document.getElementById('cPareto'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{label:'Gasto',data:s.map(x=>x[1]),backgroundColor:cl,borderRadius:3,order:2,yAxisID:'y'},{label:'% Acum',data:ap.map(p=>p*100),type:'line',borderColor:'#1e293b',borderWidth:2.5,pointRadius:3,pointBackgroundColor:'#1e293b',fill:!1,order:1,yAxisID:'y1'}]},options:{responsive:!0,interaction:{intersect:!1,mode:'index'},plugins:{legend:{position:'top',labels:{usePointStyle:!0,font:{size:10}}},datalabels:{display:!1}},scales:{y:{position:'left',ticks:{callback:v=>fm(v),font:{size:9}},grid:{color:'#f1f5f9'}},y1:{position:'right',min:0,max:100,ticks:{callback:v=>v+'%',font:{size:9}},grid:{display:!1}},x:{grid:{display:!1},ticks:{maxRotation:45,font:{size:8}}}}},plugins:[ChartDataLabels]});
  const tb=document.querySelector('#tPareto tbody');ac=0;
  tb.innerHTML=s.map(([vh,g],i)=>{ac+=g;const pA=tG?ac/tG:0,vi=pA<=.8;return`<tr><td><span class="rank ${i<3?'rank-'+(i+1):'rank-d'}">${i+1}</span></td><td>${vh}</td><td class="money">${fmf(g)}</td><td>${fp(pA)}</td><td><span class="ptag ${vi?'pv':'pt'}">${vi?'80% Vital':'20% Trivial'}</span></td></tr>`;}).join('');}

function uPH(d){dc('cParetoH');const v={};d.forEach(r=>{v[r.equipo]=(v[r.equipo]||0)+r.tiempo_estandar;});const s=Object.entries(v).sort((a,b)=>b[1]-a[1]),tH=s.reduce((a,e)=>a+e[1],0);let ac=0;const ap=s.map(([_,h])=>{ac+=h;return tH?ac/tH:0;}),cl=ap.map(p=>p<=.8?'#ea580c':'#0d9488');
  CH['cParetoH']=new Chart(document.getElementById('cParetoH'),{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{label:'Horas',data:s.map(x=>x[1]),backgroundColor:cl,borderRadius:3,order:2,yAxisID:'y'},{label:'% Acum',data:ap.map(p=>p*100),type:'line',borderColor:'#1e293b',borderWidth:2.5,pointRadius:3,pointBackgroundColor:'#1e293b',fill:!1,order:1,yAxisID:'y1'}]},options:{responsive:!0,interaction:{intersect:!1,mode:'index'},plugins:{legend:{position:'top',labels:{usePointStyle:!0,font:{size:10}}},datalabels:{display:!1}},scales:{y:{position:'left',ticks:{callback:v=>v+'h',font:{size:9}},grid:{color:'#f1f5f9'}},y1:{position:'right',min:0,max:100,ticks:{callback:v=>v+'%',font:{size:9}},grid:{display:!1}},x:{grid:{display:!1},ticks:{maxRotation:45,font:{size:8}}}}},plugins:[ChartDataLabels]});}

function uDsg(d){dc('cDesglose');const g=gb(d,r=>`${MS[r.mes]||r.mes} ${r.ano}`),p=sp(Object.keys(g));
  CH['cDesglose']=new Chart(document.getElementById('cDesglose'),{type:'bar',data:{labels:p,datasets:[{label:'Refacciones',data:p.map(x=>g[x].reduce((s,r)=>s+r.precio_refaccion,0)),backgroundColor:'#2563eb',borderRadius:3,stack:'a'},{label:'Mano Obra',data:p.map(x=>g[x].reduce((s,r)=>s+r.precio_mano_obra,0)),backgroundColor:'#7c3aed',borderRadius:3,stack:'a'},{label:'Otros',data:p.map(x=>g[x].reduce((s,r)=>s+r.precio_otros,0)),backgroundColor:'#ea580c',borderRadius:3,stack:'a'}]},options:{responsive:!0,plugins:{legend:{position:'top',labels:{usePointStyle:!0,padding:12,font:{size:10}}},datalabels:{display:!1}},scales:{y:{stacked:!0,ticks:{callback:v=>fm(v),font:{size:9}},grid:{color:'#f1f5f9'}},x:{stacked:!0,grid:{display:!1},ticks:{font:{size:9}}}}},plugins:[ChartDataLabels]});}

// ══════════════════════════════════════
// REPORT GENERATION (instant HTML)
// ══════════════════════════════════════
function generateSummary(){
  if(!RAW.length){alert('No hay datos. Use Actualizar primero.');return;}
  const d=gF();
  const tG=d.reduce((s,r)=>s+r.total,0),tH=d.reduce((s,r)=>s+r.tiempo_estandar,0),tS=d.length;
  const vU=new Set(d.map(r=>r.equipo)).size;
  const aD=tS?d.reduce((s,r)=>s+r.dias_real,0)/tS:0;
  const cA=d.filter(r=>r.dias_atraso>0).length;
  const fecha=new Date().toLocaleString('es-MX');
  const vG={};d.forEach(r=>{vG[r.equipo]=(vG[r.equipo]||0)+r.total;});
  const top5=Object.entries(vG).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const vH={};d.forEach(r=>{vH[r.equipo]=(vH[r.equipo]||0)+r.tiempo_estandar;});
  const top5h=Object.entries(vH).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const clG={};d.forEach(r=>{const c=r.clasificacion||'Sin clasificar';clG[c]=(clG[c]||0)+1;});
  const tsG={};d.forEach(r=>{const t=r.tipo_servicio||'Sin tipo';tsG[t]=(tsG[t]||0)+1;});
  const tsS=Object.entries(tsG).sort((a,b)=>b[1]-a[1]);
  const mG=gb(d,r=>`${MS[r.mes]||r.mes} ${r.ano}`);
  const mP=sp(Object.keys(mG));
  const paretoS=Object.entries(vG).sort((a,b)=>b[1]-a[1]);
  let acP=0;const totalP=paretoS.reduce((s,e)=>s+e[1],0);
  const vitales=paretoS.filter(([_,g])=>{acP+=g;return(acP-g)/totalP<0.8;});
  const tRef=d.reduce((s,r)=>s+r.precio_refaccion,0);
  const tMO=d.reduce((s,r)=>s+r.precio_mano_obra,0);
  const tOtros=d.reduce((s,r)=>s+r.precio_otros,0);
  const fA=F.year==='all'?'Todos':F.year,fMe=F.month==='all'?'Todos':cap(F.month);
  const fT=F.tipo==='all'?'Todos':F.tipo,fCl=F.clasif==='all'?'Todos':F.clasif;

  let mesR='';mP.forEach(p=>{const rr=mG[p],g=rr.reduce((s,r)=>s+r.total,0),h=rr.reduce((s,r)=>s+r.tiempo_estandar,0);mesR+=`<tr><td>${p}</td><td>${rr.length}</td><td>${fm(g)}</td><td>${fn(h)}h</td><td>${fm(rr.length?g/rr.length:0)}</td></tr>`;});
  let t5r='';top5.forEach(([v,g],i)=>{t5r+=`<tr><td>#${i+1}</td><td>${v}</td><td>${fm(g)}</td><td>${fp(totalP?g/totalP:0)}</td><td>${fn(vH[v]||0)}h</td></tr>`;});
  let t5h='';top5h.forEach(([v,h],i)=>{t5h+=`<tr><td>#${i+1}</td><td>${v}</td><td>${fn(h)}h</td><td>${fm(vG[v]||0)}</td></tr>`;});
  let clR='';Object.entries(clG).sort((a,b)=>b[1]-a[1]).forEach(([c,n])=>{clR+=`<tr><td>${c}</td><td>${n}</td><td>${fp(n/tS)}</td></tr>`;});
  let tsR='';tsS.forEach(([t,n])=>{tsR+=`<tr><td>${t}</td><td>${n}</td><td>${fp(n/tS)}</td></tr>`;});
  let pR='';acP=0;vitales.forEach(([v,g],i)=>{acP+=g;pR+=`<tr><td>#${i+1}</td><td>${v}</td><td>${fm(g)}</td><td>${fp(totalP?acP/totalP:0)}</td></tr>`;});

  const eSub=encodeURIComponent('Reporte Mantenimiento Flota - '+new Date().toLocaleDateString('es-MX')).replace(/'/g,'%27');
  const eBody=encodeURIComponent('REPORTE MANTENIMIENTO DE FLOTA
'+fecha+'

Filtros: Ano '+fA+' | Mes '+fMe+' | Tipo '+fT+' | Clasif '+fCl+'
Registros: '+d.length+' de '+RAW.length+'

INDICADORES:
- Gasto Total: '+fm(tG)+'
- Horas: '+fn(tH)+'h
- Servicios: '+tS+'
- Vehiculos: '+vU+'
- Atrasos: '+cA+' ('+((tS?(cA/tS*100).toFixed(0):0))+'%)

TOP 5 GASTO:
'+top5.map(([v,g],i)=>(i+1)+'. '+v+': '+fm(g)).join('
')+'

CONCLUSIONES:
- '+vitales.length+' vehiculos = 80% del gasto
- Refacciones: '+fm(tRef)+' | M.Obra: '+fm(tMO)+' | Otros: '+fm(tOtros)).replace(/'/g,'%27');

  const html=`<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Resumen Mantenimiento</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;color:#1e293b;background:#f8fafc}
.act{background:#1e40af;padding:12px 32px;display:flex;gap:10px;align-items:center;position:sticky;top:0;z-index:100;flex-wrap:wrap}
.act button{padding:8px 20px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px}
.bp{background:#fff;color:#1e40af}.be{background:#16a34a;color:#fff}.bc{background:#7c3aed;color:#fff}
.rpt{max-width:800px;margin:0 auto;padding:32px;background:#fff;min-height:100vh}
.hdr{background:linear-gradient(135deg,#1e40af,#2563eb);color:#fff;padding:24px;border-radius:12px;margin-bottom:24px}
.hdr h1{font-size:22px;margin-bottom:4px}.hdr p{font-size:12px;opacity:.8}
.fbox{background:#dbeafe;border:1px solid #93c5fd;border-radius:8px;padding:14px 18px;margin-bottom:24px}
.fbox h3{font-size:12px;color:#1e40af;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.tags{display:flex;gap:8px;flex-wrap:wrap}.tag{background:#fff;border:1px solid #93c5fd;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;color:#1e40af}
.cnt{font-size:11px;color:#64748b;margin-top:8px}
.kg{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
.kpi{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:14px;text-align:center}
.kpi .lb{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:#64748b;font-weight:700}
.kpi .vl{font-size:22px;font-weight:800;margin:4px 0}.kpi .sb{font-size:10px;color:#94a3b8}
.kpi.bl .vl{color:#2563eb}.kpi.tl .vl{color:#0d9488}.kpi.pp .vl{color:#7c3aed}
.kpi.or .vl{color:#ea580c}.kpi.gn .vl{color:#16a34a}.kpi.rd .vl{color:#dc2626}
section{margin-bottom:24px}h2{font-size:15px;color:#1e40af;border-left:4px solid #2563eb;padding-left:10px;margin-bottom:12px}
p.ds{font-size:12px;color:#475569;line-height:1.6;margin-bottom:12px}
table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:8px}
th{background:#f1f5f9;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.3px;color:#64748b;border-bottom:2px solid #e2e8f0}
td{padding:7px 10px;border-bottom:1px solid #f1f5f9}tr:hover{background:#f8fafc}
.conc{background:#f0fdf4;border:1px solid #86efac;border-radius:10px;padding:18px;margin-top:24px}
.conc h2{color:#166534;border-color:#16a34a}.conc li{font-size:12px;line-height:1.7;margin-bottom:8px;color:#166534}
.ft{text-align:center;padding:20px;font-size:10px;color:#94a3b8;border-top:1px solid #e2e8f0;margin-top:24px}
@media(max-width:700px){.kg{grid-template-columns:repeat(2,1fr)}.act{padding:10px 16px}.rpt{padding:16px}}
@media print{.act{display:none!important}body{background:#fff}.rpt{padding:15px;max-width:100%}section{break-inside:avoid}.hdr{break-after:avoid}}
</style></head><body>
<div class="act">
<button class="bp" onclick="window.print()">&#128424; Imprimir / Guardar PDF</button>
<button class="be" id="emailBtn">&#9993; Enviar por Correo</button>
<button class="bc" id="copyBtn">&#128203; Copiar Resumen</button>
<span style="color:rgba(255,255,255,.7);font-size:11px;margin-left:auto">${fecha}</span>
</div>
<div class="rpt" id="rc">
<div class="hdr"><h1>REPORTE EJECUTIVO - MANTENIMIENTO DE FLOTA</h1><p>Dashboard de Mantenimiento | ${fecha}</p></div>
<div class="fbox"><h3>Filtros Aplicados</h3><div class="tags"><span class="tag">Ano: ${fA}</span><span class="tag">Mes: ${fMe}</span><span class="tag">Tipo: ${fT}</span><span class="tag">Clasificacion: ${fCl}</span></div><div class="cnt">${d.length} registros filtrados de ${RAW.length} totales</div></div>
<div class="kg">
<div class="kpi bl"><div class="lb">Gasto Total</div><div class="vl">${fm(tG)}</div><div class="sb">${fm(tS?tG/tS:0)}/serv</div></div>
<div class="kpi tl"><div class="lb">Horas Totales</div><div class="vl">${fn(tH)}h</div><div class="sb">${tS?(tH/tS).toFixed(1):'0'} hrs/serv</div></div>
<div class="kpi pp"><div class="lb">Servicios</div><div class="vl">${tS}</div><div class="sb">${vU} vehiculos</div></div>
<div class="kpi or"><div class="lb">Prom Dias/Serv</div><div class="vl">${aD.toFixed(1)}</div><div class="sb">dias promedio</div></div>
<div class="kpi gn"><div class="lb">Vehiculos</div><div class="vl">${vU}</div><div class="sb">unicos en periodo</div></div>
<div class="kpi rd"><div class="lb">Con Atraso</div><div class="vl">${cA}</div><div class="sb">${tS?(cA/tS*100).toFixed(0):0}% del total</div></div>
</div>
<section><h2>Resumen Ejecutivo</h2>
<p class="ds">Analisis basado en <strong>${tS} ordenes de servicio</strong> de <strong>${vU} vehiculos</strong>. Gasto total: <strong>${fm(tG)}</strong>, consumo: <strong>${fn(tH)} horas</strong>. Promedio ${aD.toFixed(1)} dias/servicio. ${cA} servicios con atraso (${tS?(cA/tS*100).toFixed(0):0}%).</p>
<p class="ds"><strong>Desglose:</strong> Refacciones ${fm(tRef)} (${totalP?(tRef/totalP*100).toFixed(0):0}%) | Mano de Obra ${fm(tMO)} (${totalP?(tMO/totalP*100).toFixed(0):0}%) | Otros ${fm(tOtros)} (${totalP?(tOtros/totalP*100).toFixed(0):0}%)</p>
</section>
<section><h2>Gasto por Mes</h2>
<table><thead><tr><th>Periodo</th><th>Servicios</th><th>Gasto</th><th>Horas</th><th>$/Serv</th></tr></thead>
<tbody>${mesR}<tr style="background:#f0f4f8;font-weight:700"><td>TOTAL</td><td>${tS}</td><td>${fm(tG)}</td><td>${fn(tH)}h</td><td>${fm(tS?tG/tS:0)}</td></tr></tbody></table>
</section>
<section><h2>Top 5 Vehiculos - Mayor Gasto</h2>
<table><thead><tr><th>#</th><th>Vehiculo</th><th>Gasto</th><th>% Total</th><th>Horas</th></tr></thead><tbody>${t5r}</tbody></table>
</section>
<section><h2>Top 5 Vehiculos - Mayor Horas</h2>
<table><thead><tr><th>#</th><th>Vehiculo</th><th>Horas</th><th>Gasto</th></tr></thead><tbody>${t5h}</tbody></table>
</section>
<section><h2>Clasificacion de Servicios</h2>
<table><thead><tr><th>Clasificacion</th><th>Cantidad</th><th>%</th></tr></thead><tbody>${clR}</tbody></table>
</section>
<section><h2>Tipo de Servicio</h2>
<table><thead><tr><th>Tipo</th><th>Cantidad</th><th>%</th></tr></thead><tbody>${tsR}</tbody></table>
</section>
<section><h2>Pareto 80/20 - Vehiculos Vitales</h2>
<p class="ds">${vitales.length} de ${paretoS.length} vehiculos (${paretoS.length?(vitales.length/paretoS.length*100).toFixed(0):0}%) concentran el 80% del gasto:</p>
<table><thead><tr><th>#</th><th>Vehiculo</th><th>Gasto</th><th>% Acum</th></tr></thead><tbody>${pR}</tbody></table>
</section>
<div class="conc"><h2>Conclusiones y Recomendaciones</h2><ol>
<li><strong>GASTO:</strong> ${vitales.length} vehiculos = 80% del gasto. Priorizar mantenimiento preventivo.</li>
<li><strong>EFICIENCIA:</strong> ${aD.toFixed(1)} dias/serv y ${tS?(tH/tS).toFixed(1):'0'} hrs/intervencion. Evaluar disponibilidad de refacciones.</li>
<li><strong>ATRASOS:</strong> ${tS?(cA/tS*100).toFixed(0):0}% con atraso (${cA} de ${tS}). Implementar alertas tempranas.</li>
<li><strong>COSTOS:</strong> Refacciones ${fm(tRef)} (${totalP?(tRef/totalP*100).toFixed(0):0}%) | M.Obra ${fm(tMO)} (${totalP?(tMO/totalP*100).toFixed(0):0}%) | Otros ${fm(tOtros)} (${totalP?(tOtros/totalP*100).toFixed(0):0}%).</li>
</ol></div>
<div class="ft">Reporte generado desde Dashboard Ejecutivo de Mantenimiento | ${fecha}</div>
</div>
<script>
document.getElementById("emailBtn").onclick=function(){var a=document.createElement("a");a.href="mailto:?subject=${eSub}&body=${eBody}";a.click();};
document.getElementById("copyBtn").onclick=function(){var r=document.createRange();r.selectNodeContents(document.getElementById("rc"));var s=window.getSelection();s.removeAllRanges();s.addRange(r);document.execCommand("copy");s.removeAllRanges();this.innerHTML="&#10004; Copiado!";var b=this;setTimeout(function(){b.innerHTML="&#128203; Copiar Resumen"},2000);};
</script></body></html>`;

  const w=window.open('','_blank');
  if(w){w.document.write(html);w.document.close();}
  else{alert('Permite ventanas emergentes para ver el resumen.');}
}

// ── INIT ──
document.addEventListener('DOMContentLoaded',async()=>{
  console.log('[Dashboard] Iniciando carga de datos...');
  // 1. data.json local (PRIORIDAD, sin CORS, siempre funciona en GitHub Pages)
  if(await loadFromJSON()){
    console.log('[Dashboard] Datos cargados desde data.json');
    setTimeout(()=>document.getElementById('loading').classList.add('hide'),300);return;
  }
  console.warn('[Dashboard] data.json fallo, intentando cache...');
  // 2. Cache local como fallback
  const cached=localStorage.getItem('dashRAW');
  if(cached){
    try{RAW=JSON.parse(cached);const ts=localStorage.getItem('dashTS')||'Cache';
    console.log('[Dashboard] Usando cache local:',RAW.length,'registros');
    setSt('ok',RAW.length+' registros (cache) | '+ts);
    document.getElementById('bUpd').textContent=ts+' (cache)';
    document.getElementById('fTs').textContent='Datos en cache desde: '+ts;
    setupF();updateAll();
    setTimeout(()=>document.getElementById('loading').classList.add('hide'),300);return;
    }catch(e){console.warn('[Dashboard] Cache corrupto:',e.message);}
  }
  // 3. OneDrive via proxies (ultimo recurso)
  console.warn('[Dashboard] Intentando OneDrive como ultimo recurso...');
  await loadFromOneDrive();
  // 4. Siempre ocultar overlay, incluso en error
  setTimeout(()=>document.getElementById('loading').classList.add('hide'),500);
});
</script>
</body>
</html>
